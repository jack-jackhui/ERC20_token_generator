name: Deploy to Oracle Cloud Server

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
    
  deploy:
    runs-on: ubuntu-latest
    #needs: build-test # this job depends on "build-test" having finished
    if: github.ref == 'refs/heads/main' # we tell Github to only execute this step if we're on our master branch (so we don't put unfinished branches in production)
    steps:
      - name: Deploying to Oracle cloud VM
        uses: appleboy/ssh-action@master # An action made to control Linux servers
        with: # We set all our secrets here for the action, these won't be shown in the action logs
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_HOST_USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            git clone https://github.com/jack-jackhui/ERC20_token_generator.git
            cd ERC20_token_generator # we move into our app's folder
            git fetch --all
            git reset --hard origin/main
            git clean -f -d
            npm prune # we remove any unused dependencies
            npm install # we install any missing dependencies
            npm run build # we build our app
            sudo cp -R /home/ubuntu/ERC20_token_generator/dist/* /var/www/jackhui.com.au/html/ERC20-token-generator/
            sudo chown -R www-data:www-data /var/www/jackhui.com.au/html/ERC20-token-generator/
            #sudo rm -rf /home/ubuntu/ERC20_token_generator
